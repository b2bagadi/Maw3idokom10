generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      String
  name      String
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  business       Business?
  clientBookings Booking[]  @relation("ClientBookings")
  clientReviews  Review[]   @relation("ClientReviews")
  sentMessages   Message[]  @relation("SentMessages")

  @@index([email])
  @@index([role])
}

model Business {
  id                 String   @id @default(cuid())
  userId             String   @unique
  name               String
  logoUrl            String?
  heroUrl            String?
  description        String?
  address            String
  lat                Float?
  lng                Float?
  phone              String?
  averageRating      Float    @default(0)
  totalReviews       Int      @default(0)
  categoryId         String
  subscriptionPlanId String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  category         Category          @relation(fields: [categoryId], references: [id])
  subscriptionPlan SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  services         Service[]
  staff            Staff[]
  schedules        Schedule[]
  emergencyBlocks  EmergencyBlock[]
  bookings         Booking[]         @relation("BusinessBookings")
  reviews          Review[]          @relation("BusinessReviews")
  gallery          BusinessImage[]

  @@index([categoryId])
  @@index([subscriptionPlanId])
  @@index([averageRating])
}

model Category {
  id         String   @id @default(cuid())
  nameEn     String   @unique
  nameFr     String
  nameAr     String
  emoji      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  isFeatured Boolean  @default(true)

  businesses Business[]
}

model SubscriptionPlan {
  id            String   @id @default(cuid())
  name          String   @unique
  features      String
  pricePerMonth Int
  maxServices   Int      @default(10)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  businesses Business[]
}

model Service {
  id          String   @id @default(cuid())
  businessId  String
  name        String
  description String?
  price       Int
  duration    Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  business Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([businessId])
  @@index([price])
}

model Staff {
  id         String   @id @default(cuid())
  businessId String
  name       String
  avatarUrl  String?
  role       String?
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  bookings Booking[]

  @@index([businessId])
}

model Schedule {
  id         String   @id @default(cuid())
  businessId String
  dayOfWeek  Int
  openTime   String?
  closeTime  String?
  isClosed   Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@unique([businessId, dayOfWeek])
  @@index([businessId])
}

model EmergencyBlock {
  id         String   @id @default(cuid())
  businessId String
  startDate  DateTime
  endDate    DateTime
  reason     String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  business Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([startDate, endDate])
}

model Booking {
  id         String   @id @default(cuid())
  clientId   String
  businessId String
  serviceId  String
  staffId    String?
  date       DateTime
  time       String
  status     String   @default("PENDING")
  totalPrice Int
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  client   User      @relation("ClientBookings", fields: [clientId], references: [id], onDelete: Cascade)
  business Business  @relation("BusinessBookings", fields: [businessId], references: [id], onDelete: Cascade)
  service  Service   @relation(fields: [serviceId], references: [id])
  staff    Staff?    @relation(fields: [staffId], references: [id])
  review   Review?
  messages Message[]

  @@index([clientId])
  @@index([businessId])
  @@index([date])
  @@index([status])
}

model Review {
  id         String   @id @default(cuid())
  bookingId  String   @unique
  clientId   String
  businessId String
  rating     Int
  comment    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  booking  Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  client   User     @relation("ClientReviews", fields: [clientId], references: [id], onDelete: Cascade)
  business Business @relation("BusinessReviews", fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([rating])
}

model Message {
  id        String   @id @default(cuid())
  bookingId String
  senderId  String
  text      String
  createdAt DateTime @default(now())

  booking Booking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  sender  User    @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([createdAt])
}

model GlobalSettings {
  id      String @id @default(cuid())
  key     String @unique
  valueEn String
  valueFr String
  valueAr String

  @@index([key])
}

model ContactSubmission {
  id        String   @id @default(cuid())
  name      String
  email     String
  message   String
  createdAt DateTime @default(now())
}

model BusinessImage {
  id         String   @id @default(cuid())
  url        String
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@index([businessId])
}
